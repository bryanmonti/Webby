<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" media="all" href="css/style.css">
</head>
<body>

<!--Anytime there is a region use the onclick span thingy and jQuery hide() function to hide that object! Also use onclick() so they can re-open what they closed -->

<!-- Generated by C# Formatter (written in Python)
     By: Bryan Monti
     Date: 5/18/12
     Time: 22:30:56 -->
<div id='code'>
<span id='blue'>#region</span> Using</br>
<span id='blue'>using</span> System;</br><!-- figure out why it enters everytime there is a <div> tag! -->
<span id='blue'>using</span> System.Collections.Generic;</br>
<span id='blue'>using</span> System.IO;</br>
<span id='blue'>using</span> System.IO.Ports;</br>
<span id='blue'>using</span> System.Linq;</br>
<span id='blue'>using</span> System.Text;</br>
<span id='blue'>using</span> System.Threading;</br>
<span id='blue'>using</span> Microsoft.Kinect;</br>
<span id='blue'>using</span> Microsoft.Speech.AudioFormat;</br>
<span id='blue'>using</span> Microsoft.Speech.Recognition;</br>
<span id='blue'>#endregion</span></br>

<span id='blue'>namespace</span> Speech</br>
{<span id='green'> //Pissing people off with #regions since Microsoft Visual 2008.</span></br>
    <span id='indent'><span id='blue'>public class</span> <span id='lightblue'>Program</span></span></br>
    <span id='indent'>{</span></br>
        <span id='indent2'><span id='blue'>public static</span> System.IO.Ports.SerialPort port;<span id='green'> //try using</span></span></br>
        <span id='indent2'></span><span id='blue'>public static void</span> Main(<span id='blue'>string</span>[ ] args)</span></br>
        <span id='indent2'>{</span></br>
            <span id='indent3'><span id='blue'>int</span> baud;</span></br>
            <span id='indent3'><span id='blue'>string</span> name;</span></br></br>

            <span id='indent3'><span id='blue'>#region</span> Kinect Finding</span></br>
            <span id='indent3'><span id='green'>// Obtain a KinectSensor if any are available</span></span></br>
            <span id='indent3'>KinectSensor sensor = (<span id='blue'>from</span> sensorToCheck <span id='blue'>in</span> KinectSensor.KinectSensors <span id='blue'>where</span> sensorToCheck.Status == KinectStatus.Connected <span id='blue'>select</span> sensorToCheck).FirstOrDefault();</span></br>
            <span id='indent3'><span id='blue'>#endregion</span></span></br></br>

            <span id='indent3'><span id='blue'>#region</span> Kinect Checking</span></br>
            <span id='indent3'><span id='blue'>if</span> (sensor == <span id='blue'>null</span>)</span></br>
            <span id='indent3'>{</span></br>
                <span id='indent4'><span id='lightblue'>Console</span>.WriteLine(</span></br>
                    <span id='indent5'><span id='red'>"No Kinect sensors are attached to this computer or none of the ones that are\n"</span> +</span></br>
                    <span id='indent5'><span id='red'>"attached are \"Connected\".\n"</span> +</span></br>
                    <span id='indent5'><span id='green'>//"Attach the KinectSensor and restart this application.\n" +</span></span></br>
                    <span id='indent5'><span id='green'>//"If that doesn't work run SkeletonViewer-WPF to better understand the Status of\n" +</span></span></br>
                    <span id='indent5'><span id='green'>//"the Kinect sensors.\n\n" +</span></span></br>
                    <span id='indent5'><span id='red'>"Press any key to continue.\n"</span>);</span></br></br>

                <span id='indent4'><span id='green'>//Give a chance for user to see console output before it is dismissed</span></span></br>
                <span id='indent4'><span id='lightblue'>Console</span>.ReadKey(<span id='blue'>true</span>);</span></br>
                <span id='indent4'><span id='blue'>return;</span></span></br>
            <span id='indent3'>}</span></br>
            <span id='indent3'><span id='blue'>#endregion</span></span></br>

#region Port Checking + Counting
SerialPort.GetPortNames().Count(); //counts available ports (set this as a name somewhere)
#endregion

#region Activates Kinect Sensor
sensor.Start();
#endregion

#region Obtains KinectAudioSource
KinectAudioSource source = sensor.AudioSource;
source.EchoCancellationMode = EchoCancellationMode.None; // No AEC :(
source.AutomaticGainControlEnabled = false; // Important to turn this off for speech recognition
#endregion

#region Check for Audio SDK
if (GetKinectRecognizer() == null)
{
Console.WriteLine("Could not find Kinect speech recognizer! You should probably install the Audio SDK for Kinect (released by Microsoft)"); //Put a download link here to get the audio sdk from microsoft for kinect
return;
}
#endregion

#region Writes Options
Console.WriteLine("Enter your parameters to begin");
Console.WriteLine(" ");
Console.WriteLine("If no ports are displayed below, please check your connection to the serial device");
Console.WriteLine("Available ports:");
#endregion

#region Available Port Printing
if (System.IO.Ports.SerialPorts.GetPortNames())
{
foreach (string p in System.IO.Ports.SerialPort.GetPortNames())
{
Console.WriteLine(p);
}
}
else
{
Console.WriteLine("No Ports are available. Press any key to quit!");
Console.ReadLine();
return; //Quit
}
#endregion

#region Gets Port Name + Baud
Console.WriteLine("Port Name:");
name = Console.ReadLine();
Console.WriteLine(" ");
Console.WriteLine("Baud rate:\n" +
"1. 300\n" +
"2. 1200\n" +
"3. 2400\n" +
"4. 4800\n" +
"5. 9600\n" +
"6. 14400\n" +
"7. 19200\n" +
"8. 28800\n" +
"9. 38400\n" +
"10. 57600\n" +
"11. 115200\n");
#endregion

int wait = 2;
while (wait > -1)//stops printing at 0 seconds
{
Console.Write("Device will be ready for speech recognition in {0} second(s).\r", wait--);//overwrite last printed statement
Thread.Sleep(1000);
}

using (var sre = new SpeechRecognitionEngine(GetKinectRecognizer().Id))
{
var commands = new Choices(); //Change this variable from colors to Commands Update: DONE BITCHES

commands.Add("Dim plus far window shades");
commands.Add("Dim minus far window shades");
commands.Add("Dim plus computer window shades");
commands.Add("Dim minus computer window shades");
commands.Add("Open far window shades");
commands.Add("Close far window shades");
commands.Add("Close computer window shades");
commands.Add("Open computer window shades");

//Might have to fix below to one line
var gb = new GrammarBuilder
{
Culture = GetKinectRecognizer().Culture
};

// Specify the culture to match the recognizer in case we are running in a different culture.
gb.Append(commands);

// Create the actual Grammar instance, and then load it into the speech recognizer.
var g = new Grammar(gb);

sre.LoadGrammar(g);
sre.SpeechRecognized += SreSpeechRecognized;
sre.SpeechHypothesized += SreSpeechHypothesized;
sre.SpeechRecognitionRejected += SreSpeechRecognitionRejected;

using (Stream s = source.Start())
{
sre.SetInputToAudioStream(
s, new SpeechAudioFormatInfo(EncodingFormat.Pcm, 16000, 16, 1, 32000, 2, null));

Console.WriteLine(" ");
Console.WriteLine("What would you like me to do?\n" +
"  \n" +
"1) Dim Plus Far Window Shades\n" +
"  \n" +
"2) Dim Minus Far Window Shades\n" +
"  \n" +
"3) Dim Plus Computer Window Shades\n" +
"  \n" +
"4) Dim Minus Computer Window Shades\n" +
"  \n" +
"5) Open Far Window Shades\n" +
"  \n" +
"6) Close Far Window Shades\n" +
"  \n" +
"7) Open Computer Window Shades\n" +
"  \n" +
"8) Close Computer Window Shades\n");

sre.RecognizeAsync(RecognizeMode.Multiple);
Console.ReadLine();
Console.WriteLine("Stopping everything...gimmie a sec");
sre.RecognizeAsyncStop();
}
}

sensor.Stop();
}

private static RecognizerInfo GetKinectRecognizer()
{
Func<RecognizerInfo, bool> matchingFunc = r =>
{
string value;
r.AdditionalInfo.TryGetValue("Kinect", out value);
return "True".Equals(value, StringComparison.InvariantCultureIgnoreCase) && "en-US".Equals(r.Culture.Name, StringComparison.InvariantCultureIgnoreCase);
};
return SpeechRecognitionEngine.InstalledRecognizers().Where(matchingFunc).FirstOrDefault();
}

private static void SreSpeechRecognitionRejected(object sender, SpeechRecognitionRejectedEventArgs audio)
{
Console.WriteLine("\nSpeech not recognized");
if (audio.Result != null)
{
DumpRecordedAudio(audio.Result.Audio);
}
}

private static void SreSpeechHypothesized(object sender, SpeechHypothesizedEventArgs e)
{
Console.Write("\rSpeech Hypothesized: \t{0}", e.Result.Text);
}

private static void SreSpeechRecognized(object sender, SpeechRecognizedEventArgs e)
{
if (e.Result.Confidence >= 0.7)
{
Console.WriteLine("\nSpeech Recognized: \t{0}\tConfidence:\t{1}", e.Result.Text, e.Result.Confidence);
//Add a line here that sends recieved audio to serial
if(e.Result.Text == "open far window shades")
{
//send to serial
}
if (e.Result.Text == "WHATEVER ELSE")
{
//send to serial
}
//so on and so fourth
}
else
{
Console.WriteLine("\nSpeech Recognized but confidence was too low: \t{0}", e.Result.Confidence);
DumpRecordedAudio(e.Result.Audio); //deletes extra audio after being analyzed
}
}

private static void DumpRecordedAudio(RecognizedAudio audio)
{
if (audio == null)
{
return;
}

int fileId = 0;
string filename;
while (File.Exists((filename = "RetainedAudio_" + fileId + ".wav")))
{
fileId++;
}

Console.WriteLine("\nWriting file: {0}", filename);
using (var file = new FileStream(filename, System.IO.FileMode.CreateNew))
{
audio.WriteToWaveStream(file);
}
}

//public static int SerialCount { get; set; }
}
}

</div>
</body>
</html>